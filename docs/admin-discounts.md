# Админ: Скидки — таргетирование и комбинации

Этот документ описывает, как настраивать скидки в админ‑панели, включая простые таргеты и расширенные группы условий.

## Базовая модель скидки

Поля:

- `type`: `percent` или `fixed`
- `value`: число (проценты для `percent` или сумма для `fixed`)
- `isActive`: включена/выключена
- `startsAt`, `endsAt`: окно действия (опционально)
- `priority`: при `stackable=true` — порядок применения; при `stackable=false` — участник выбора лучшей одиночной скидки
- `stackable`: можно ли складывать со скидками того же товара/варианта

Таргетирование (старый способ, по отдельным полям):

- `productIds`: конкретные товары
- `categoryIds`: категории товаров
- `manufacturerIds`: производитель (на уровне варианта)
- `countryIds`: страна (на уровне варианта)
- `tags`: теги товара

Логика: если поле не задано (пустой массив), оно не ограничивает скидку. Для каждого поля условие — OR.

## Расширенные группы условий: `targetGroups`

Чтобы таргетировать по пересечению параметров (например, «Категория И Страна», или «Категория И (Производитель A ИЛИ Производитель B)»), используйте `targetGroups`.

- `targetGroups` — массив групп.
- Скидка применяется, если совпала хотя бы одна группа (OR между группами).
- Внутри каждой группы условия объединяются по AND.
- Каждая группа может указывать любые поля из списка: `productIds`, `categoryIds`, `manufacturerIds`, `countryIds`, `tags`.
- Поля, не указанные в группе, не ограничивают.

Важно: если одновременно заданы и `targetGroups`, и старшие поля (`categoryIds` и т.д.), то оба условия действуют одновременно — нужно совпасть хотя бы с одной группой И пройти старшие поля. Если хотите управлять только группами — оставляйте старшие поля пустыми.

### Примеры

1. Категория C1 И страна UA:

```json
{
  "name": "C1 + UA 10%",
  "type": "percent",
  "value": 10,
  "isActive": true,
  "targetGroups": [{ "categoryIds": ["<C1>"], "countryIds": ["<UA>"] }]
}
```

2. Категория C1 И (Производитель M1 ИЛИ M2):

```json
{
  "name": "C1 + (M1 or M2) 15%",
  "type": "percent",
  "value": 15,
  "isActive": true,
  "targetGroups": [
    { "categoryIds": ["<C1>"], "manufacturerIds": ["<M1>"] },
    { "categoryIds": ["<C1>"], "manufacturerIds": ["<M2>"] }
  ]
}
```

3. Конкретные товары И теги:

```json
{
  "name": "Exact products with tag 'stock' -50",
  "type": "fixed",
  "value": 50,
  "isActive": true,
  "targetGroups": [{ "productIds": ["<P1>", "<P2>"], "tags": ["stock"] }]
}
```

## Применение на витрине

- Проверка соответствия скидке выполняется на уровне варианта товара:
  - `countryId` и `manufacturerId` берутся из варианта.
  - `categoryIds`, `tags` и `productId` — из товара.
- Возвращаемые цены и данные:
  - Варианты содержат `priceFinal`, `priceOriginal` и список `discountsApplied`.
  - Агрегаты `priceMinFinal`/`priceMaxFinal` пересчитываются по вариантам.

## Как это уживается с несколькими скидками

- Если есть несколько скидок, подходящих к одному варианту:
  - Нестэкабельные (`stackable=false`) — выбирается лучшая одиночная (даёт минимальную цену).
  - Затем стэкабельные (`stackable=true`) применяются последовательно по возрастанию `priority` (чем больше `priority`, тем позже применится).

## Подсказки по настройке

- Хотите, чтобы группы полностью управляли областью применения? Оставляйте старшие поля пустыми.
- Если у товара есть варианты из разных стран/производителей, используйте `targetGroups` или поля `countryIds`/`manufacturerIds` — они матчятся на уровне варианта, и скидка применится только к соответствующим вариантам.
- Если нужно «Категория и все её подкатегории» — это можно расширить отдельным флагом, либо дублировать категории в таргете.

---

Если потребуется, добавим в админку удобный UI для конструирования групп ("Добавить группу" → выбрать категорию/страну/производителя/теги), а также предпросмотр результирующей выборки.
